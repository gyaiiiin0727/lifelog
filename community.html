<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Dayce Community</title>
<meta name="description" content="Dayceãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äº¤æµãƒ»æƒ…å ±å…±æœ‰ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£">
<link rel="icon" href="./icon.jpg">
<style>
:root {
  --black: #111;
  --white: #fff;
  --blue: #2196F3;
  --blue-dark: #1976D2;
  --gray-50: #f8f9fa;
  --gray-100: #f0f0f0;
  --gray-200: #e5e7eb;
  --gray-400: #999;
  --gray-600: #666;
  --green: #27ae60;
  --red: #e74c3c;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif; background: var(--gray-50); color: var(--black); -webkit-font-smoothing: antialiased; min-height: 100vh; }
.hidden { display: none !important; }
.cm-header { position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.92); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--gray-100); padding: 10px 16px; padding-top: max(env(safe-area-inset-top, 10px), 10px); }
.cm-header-inner { max-width: 640px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
.cm-logo { display: flex; align-items: center; gap: 6px; text-decoration: none; color: var(--black); }
.cm-logo img { width: 28px; height: 28px; border-radius: 6px; }
.cm-logo span { font-size: 18px; font-weight: 800; }
.cm-logo small { font-size: 10px; color: var(--gray-400); margin-left: 2px; }
.cm-header-user { display: flex; align-items: center; gap: 10px; }
.cm-header-link { font-size: 12px; color: var(--blue); text-decoration: none; }
.cm-avatar-sm { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 13px; font-weight: 700; cursor: pointer; flex-shrink: 0; }
.cm-tabs { display: flex; gap: 0; background: var(--gray-100); border-radius: 10px; padding: 3px; max-width: 300px; margin: 8px auto 0; }
.cm-tab { flex: 1; padding: 7px 0; border: none; border-radius: 8px; background: transparent; font-size: 13px; font-weight: 600; color: var(--gray-600); cursor: pointer; transition: all 0.2s; }
.cm-tab.active { background: var(--black); color: var(--white); }
.cm-container { max-width: 640px; margin: 0 auto; padding: 16px; }
.cm-section-title { font-size: 16px; font-weight: 700; margin: 20px 0 12px; }
.cm-section-title:first-child { margin-top: 0; }
.cm-card { background: var(--white); border: 1px solid var(--gray-200); border-radius: 14px; padding: 16px; margin-bottom: 12px; }
.cm-featured { display: flex; gap: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; scroll-snap-type: x mandatory; }
.cm-featured::-webkit-scrollbar { display: none; }
.cm-featured-card { flex: 0 0 280px; scroll-snap-align: start; background: var(--white); border: 1px solid var(--gray-200); border-radius: 14px; padding: 16px; cursor: pointer; transition: border-color 0.2s; }
.cm-featured-card:hover { border-color: var(--blue); }
.cm-featured-tag { display: inline-block; font-size: 11px; font-weight: 600; color: var(--blue); background: #e3f2fd; padding: 2px 8px; border-radius: 6px; margin-bottom: 8px; }
.cm-featured-title { font-size: 15px; font-weight: 700; line-height: 1.4; margin-bottom: 6px; }
.cm-featured-excerpt { font-size: 13px; color: var(--gray-600); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.cm-featured-meta { font-size: 11px; color: var(--gray-400); margin-top: 8px; }
.cm-cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.cm-cat-card { background: var(--white); border: 1.5px solid var(--gray-200); border-radius: 14px; padding: 16px 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
.cm-cat-card:hover { border-color: var(--blue); background: #f0f7ff; }
.cm-cat-emoji { font-size: 28px; display: block; margin-bottom: 6px; }
.cm-cat-label { font-size: 14px; font-weight: 700; color: var(--black); }
.cm-thread-item { background: var(--white); border: 1px solid var(--gray-200); border-radius: 12px; padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s; }
.cm-thread-item:hover { border-color: var(--blue); }
.cm-thread-title { font-size: 15px; font-weight: 700; line-height: 1.4; margin-bottom: 4px; }
.cm-thread-meta { font-size: 12px; color: var(--gray-400); display: flex; gap: 12px; align-items: center; }
.cm-thread-op { background: var(--white); border: 1px solid var(--gray-200); border-radius: 14px; padding: 20px 16px; margin-bottom: 16px; }
.cm-thread-op-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; line-height: 1.4; }
.cm-thread-op-body { font-size: 14px; line-height: 1.8; white-space: pre-wrap; }
.cm-author-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.cm-author-name { font-size: 13px; font-weight: 600; }
.cm-article-body { font-size: 15px; line-height: 1.9; white-space: pre-wrap; }
.cm-comments-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
.cm-comment { padding: 10px 0; border-bottom: 1px solid var(--gray-100); }
.cm-comment:last-child { border-bottom: none; }
.cm-comment-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
.cm-comment-nick { font-size: 12px; font-weight: 600; }
.cm-comment-time { font-size: 11px; color: var(--gray-400); }
.cm-comment-body { font-size: 13px; line-height: 1.6; }
.cm-comment-del { font-size: 11px; color: var(--gray-400); cursor: pointer; margin-left: auto; }
.cm-comment-del:hover { color: var(--red); }
.cm-input { width: 100%; padding: 12px 14px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-size: 15px; outline: none; font-family: inherit; }
.cm-input:focus { border-color: var(--blue); }
.cm-textarea { width: 100%; padding: 12px 14px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-size: 15px; outline: none; font-family: inherit; resize: vertical; min-height: 80px; }
.cm-textarea:focus { border-color: var(--blue); }
.cm-btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
.cm-btn-primary { background: var(--blue); color: var(--white); }
.cm-btn-primary:hover { background: var(--blue-dark); }
.cm-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.cm-btn-outline { background: transparent; border: 1.5px solid var(--gray-200); color: var(--gray-600); }
.cm-btn-outline:hover { border-color: var(--blue); color: var(--blue); }
.cm-btn-sm { padding: 6px 14px; font-size: 13px; }
.cm-form-group { margin-bottom: 14px; }
.cm-form-label { font-size: 13px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; display: block; }
.cm-char-count { font-size: 11px; color: var(--gray-400); text-align: right; margin-top: 4px; }
.cm-reply-form { display: flex; gap: 8px; margin-top: 12px; }
.cm-reply-form .cm-input { flex: 1; padding: 10px 12px; font-size: 14px; }
.cm-tag { display: inline-block; font-size: 11px; color: var(--blue); background: #e3f2fd; padding: 2px 8px; border-radius: 6px; margin-right: 4px; }
.cm-filter-pills { display: flex; gap: 8px; flex-wrap: wrap; }
.cm-filter-pill { padding: 6px 14px; border: 1.5px solid var(--gray-200); border-radius: 20px; background: var(--white); font-size: 13px; font-weight: 600; color: var(--gray-600); cursor: pointer; transition: all 0.2s; }
.cm-filter-pill.active { border-color: var(--blue); color: var(--blue); background: #e3f2fd; }
.cm-back { display: inline-flex; align-items: center; gap: 4px; font-size: 13px; color: var(--gray-600); cursor: pointer; margin-bottom: 12px; background: none; border: none; font-family: inherit; }
.cm-back:hover { color: var(--blue); }
.cm-login-prompt { background: #e3f2fd; border-radius: 12px; padding: 16px; text-align: center; font-size: 14px; color: var(--blue-dark); margin-top: 12px; }
.cm-login-prompt a { color: var(--blue); font-weight: 600; }
.cm-cta { background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%); border-radius: 14px; padding: 24px 20px; text-align: center; color: #fff; margin: 20px 0; }
.cm-cta h3 { font-size: 16px; margin-bottom: 6px; }
.cm-cta p { font-size: 13px; opacity: 0.9; margin-bottom: 12px; }
.cm-cta a { display: inline-block; background: #fff; color: var(--blue); padding: 10px 24px; border-radius: 10px; font-weight: 700; font-size: 14px; text-decoration: none; }
.cm-empty { text-align: center; padding: 40px 16px; color: var(--gray-400); }
.cm-empty-icon { font-size: 40px; margin-bottom: 8px; }
.cm-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--black); color: var(--white); padding: 12px 24px; border-radius: 24px; font-size: 14px; z-index: 99999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
.cm-toast.show { opacity: 1; }
.cm-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 16px; }
.cm-modal { background: var(--white); border-radius: 16px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; padding: 24px 20px; }
.cm-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
.cm-modal-close { float: right; font-size: 24px; cursor: pointer; color: var(--gray-400); background: none; border: none; line-height: 1; }
.cm-loading { text-align: center; padding: 32px; color: var(--gray-400); }
.cm-footer { text-align: center; padding: 24px 16px; font-size: 12px; color: var(--gray-400); }
</style>
</head>
<body>
<header class="cm-header">
  <div class="cm-header-inner">
    <a href="./lp.html" class="cm-logo"><img src="./icon.jpg" alt="Dayce" width="28" height="28"><span>ayce</span><small>Community</small></a>
    <div class="cm-header-user" id="headerUser"><a href="./index.html" class="cm-header-link">ãƒ­ã‚°ã‚¤ãƒ³</a></div>
  </div>
  <div class="cm-tabs" id="mainTabs">
    <button class="cm-tab active" onclick="switchTab('home')" data-tab="home">ãƒ›ãƒ¼ãƒ </button>
    <button class="cm-tab" onclick="switchTab('articles')" data-tab="articles">è¨˜äº‹</button>
    <button class="cm-tab" onclick="switchTab('forum')" data-tab="forum">äº¤æµ</button>
  </div>
</header>
<main class="cm-container">
<section id="tabHome">
  <h3 class="cm-section-title">ğŸ“ æ³¨ç›®ã®è¨˜äº‹</h3>
  <div class="cm-featured" id="homeFeatured"><div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <h3 class="cm-section-title">ğŸ’¬ æœ€æ–°ã®äº¤æµ</h3>
  <div id="homeRecent"><div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  <div id="homeCta" class="cm-cta hidden">
    <h3>Dayceã§æ¯æ—¥ã‚’è¨˜éŒ²ã—ã‚ˆã†</h3>
    <p>å£°ã§æ—¥è¨˜ã‚’æ›¸ã„ã¦ã€AIãŒã‚ãªãŸã®æ°—ã¥ãã‚’æ•´ç†ã—ã¾ã™</p>
    <a href="./index.html">ã‚¢ãƒ—ãƒªã‚’å§‹ã‚ã‚‹ â†’</a>
  </div>
</section>
<section id="tabArticles" class="hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <div class="cm-filter-pills" id="articleFilters">
      <button class="cm-filter-pill active" onclick="filterArticles('all')">ã™ã¹ã¦</button>
      <button class="cm-filter-pill" onclick="filterArticles('admin')">ğŸ“Œ é‹å–¶</button>
      <button class="cm-filter-pill" onclick="filterArticles('user')">âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼</button>
    </div>
    <button class="cm-btn cm-btn-primary cm-btn-sm hidden" id="writeArticleBtn" onclick="showNewArticleModal()">âœï¸ è¨˜äº‹ã‚’æ›¸ã</button>
  </div>
  <div id="articleList"></div>
  <div id="articleDetail" class="hidden"></div>
  <button class="cm-btn cm-btn-outline hidden" id="articleLoadMore" onclick="loadArticles(false)" style="width:100%;margin-top:8px;">ã‚‚ã£ã¨èª­ã‚€</button>
</section>
<section id="tabForum" class="hidden">
  <div id="forumCategories">
    <h3 class="cm-section-title">ğŸ¯ ç›®æ¨™ã‚«ãƒ†ã‚´ãƒª</h3>
    <div class="cm-cat-grid" id="goalCats"></div>
    <h3 class="cm-section-title">ğŸ’­ ç”¨é€”ã‚«ãƒ†ã‚´ãƒª</h3>
    <div class="cm-cat-grid" id="purposeCats"></div>
  </div>
  <div id="forumThreads" class="hidden">
    <button class="cm-back" onclick="showForumCategories()">â† ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</button>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h3 class="cm-section-title" id="threadListTitle" style="margin:0;"></h3>
      <button class="cm-btn cm-btn-primary cm-btn-sm hidden" id="newThreadBtn" onclick="showNewThreadModal()">ï¼‹ æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰</button>
    </div>
    <div id="threadList"></div>
    <button class="cm-btn cm-btn-outline hidden" id="threadLoadMore" onclick="loadThreads(false)" style="width:100%;margin-top:8px;">ã‚‚ã£ã¨èª­ã‚€</button>
  </div>
  <div id="forumThread" class="hidden">
    <button class="cm-back" id="threadBackBtn" onclick="backToThreads()">â† ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</button>
    <div id="threadDetail"></div>
  </div>
</section>
</main>
<div class="cm-toast" id="toast"></div>
<footer class="cm-footer">&copy; 2025 Dayce Community</footer>
<script>
'use strict';
var API='https://api.dayce.app';
var COLORS=['#e74c3c','#2196F3','#27ae60','#f39c12','#9b59b6','#1abc9c','#e67e22','#3498db'];
var CATEGORIES={goal:[{id:'health',emoji:'ğŸ’ª',label:'å¥åº·'},{id:'work',emoji:'ğŸ’¼',label:'ä»•äº‹'},{id:'study',emoji:'ğŸ“š',label:'å­¦ç¿’'},{id:'hobby',emoji:'ğŸ¨',label:'è¶£å‘³'}],purpose:[{id:'question',emoji:'â“',label:'è³ªå•ãƒ»ç›¸è«‡'},{id:'chat',emoji:'ğŸ’¬',label:'é›‘è«‡'},{id:'result',emoji:'ğŸ†',label:'æˆæœå ±å‘Š'},{id:'tips',emoji:'ğŸ’¡',label:'Tipså…±æœ‰'}]};
var ALL_CATS=CATEGORIES.goal.concat(CATEGORIES.purpose);
function catInfo(id){return ALL_CATS.find(function(c){return c.id===id;})||{emoji:'ğŸ’¬',label:id||'é›‘è«‡'};}
var currentUser=null,activeTab='home',articleFilter='all',articleCursor=null,currentCategory=null,threadCursor=null,currentThreadId=null;

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function timeAgo(iso){var d=Date.now()-new Date(iso).getTime();if(d<60000)return'ãŸã£ãŸä»Š';if(d<3600000)return Math.floor(d/60000)+'åˆ†å‰';if(d<86400000)return Math.floor(d/3600000)+'æ™‚é–“å‰';return Math.floor(d/86400000)+'æ—¥å‰';}
function avatarColor(e){var h=0;for(var i=0;i<(e||'').length;i++)h=((h<<5)-h)+e.charCodeAt(i);return COLORS[Math.abs(h)%COLORS.length];}
function avatarHTML(n,e,s){s=s||30;return'<div class="cm-avatar-sm" style="width:'+s+'px;height:'+s+'px;background:'+avatarColor(e)+';font-size:'+(s*0.43)+'px;">'+esc((n||'?')[0])+'</div>';}
function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2500);}
function truncate(s,n){return s&&s.length>n?s.slice(0,n)+'...':s;}
async function apiFetch(p,o){o=o||{};var h={'Content-Type':'application/json'};var tk=localStorage.getItem('syncAuthToken');if(tk)h['Authorization']='Bearer '+tk;var fo={method:o.method||'GET',headers:h};if(o.body)fo.body=JSON.stringify(o.body);var r=await fetch(API+p,fo);var d=await r.json();if(!r.ok)throw new Error(d.error||'Error');return d;}
function requireLogin(){if(currentUser){if(!currentUser.nickname){showNicknameModal();return false;}return true;}showToast('æŠ•ç¨¿ã™ã‚‹ã«ã¯Dayceã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');return false;}

async function initUser(){var tk=localStorage.getItem('syncAuthToken'),em=localStorage.getItem('syncAuthEmail');if(!tk||!em){currentUser=null;updateAuthUI();return;}try{var d=await apiFetch('/api/community/me');currentUser={email:d.email||em,nickname:d.nickname,isAdmin:d.isAdmin||false};}catch(e){currentUser=null;}updateAuthUI();}
function updateAuthUI(){var el=document.getElementById('headerUser');if(currentUser){el.innerHTML=avatarHTML(currentUser.nickname||currentUser.email,currentUser.email,30)+'<a href="./index.html" class="cm-header-link">ã‚¢ãƒ—ãƒª</a>';}else{el.innerHTML='<a href="./index.html" class="cm-header-link">ãƒ­ã‚°ã‚¤ãƒ³</a>';}var wb=document.getElementById('writeArticleBtn');if(wb)wb.classList.toggle('hidden',!currentUser);var nt=document.getElementById('newThreadBtn');if(nt)nt.classList.toggle('hidden',!currentUser);var cta=document.getElementById('homeCta');if(cta)cta.classList.toggle('hidden',!!currentUser);}

function switchTab(tab){activeTab=tab;document.getElementById('tabHome').classList.toggle('hidden',tab!=='home');document.getElementById('tabArticles').classList.toggle('hidden',tab!=='articles');document.getElementById('tabForum').classList.toggle('hidden',tab!=='forum');document.querySelectorAll('.cm-tab').forEach(function(b){b.classList.toggle('active',b.getAttribute('data-tab')===tab);});location.hash=tab;if(tab==='home')loadHome();if(tab==='articles'){showArticleList();loadArticles(true);}if(tab==='forum')showForumCategories();}

async function loadHome(){var fe=document.getElementById('homeFeatured'),re=document.getElementById('homeRecent');fe.innerHTML='<div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';re.innerHTML='<div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';try{var[ar,pr]=await Promise.all([apiFetch('/api/community/articles?limit=5'),apiFetch('/api/community/posts?limit=5')]);if(ar.articles&&ar.articles.length>0){fe.innerHTML=ar.articles.map(function(a){return'<div class="cm-featured-card" onclick="switchTab(\'articles\');showArticleDetail(\''+esc(a.id)+'\')">'+'<div class="cm-featured-tag">'+(a.type==='admin'?'ğŸ“Œ é‹å–¶':'âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼')+'</div>'+'<div class="cm-featured-title">'+esc(a.title)+'</div>'+'<div class="cm-featured-excerpt">'+esc(truncate(a.body,80))+'</div>'+'<div class="cm-featured-meta">'+esc(a.nickname)+' Â· '+timeAgo(a.createdAt)+'</div></div>';}).join('');}else{fe.innerHTML='<div class="cm-empty" style="padding:20px;"><div class="cm-empty-icon">ğŸ“</div>ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';}if(pr.posts&&pr.posts.length>0){re.innerHTML=pr.posts.map(function(p){var ci=catInfo(p.category);var t=p.title||truncate(p.body,40);return'<div class="cm-thread-item" onclick="switchTab(\'forum\');openThreadDirect(\''+esc(p.id)+'\',\''+esc(p.category||'chat')+'\')">'+'<div class="cm-thread-title">'+ci.emoji+' '+esc(t)+'</div>'+'<div class="cm-thread-meta"><span>'+esc(p.nickname)+'</span><span>ğŸ’¬ '+(p.commentCount||0)+'</span><span>'+timeAgo(p.lastActivity||p.createdAt)+'</span></div></div>';}).join('');}else{re.innerHTML='<div class="cm-empty" style="padding:20px;"><div class="cm-empty-icon">ğŸ’¬</div>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';}}catch(e){fe.innerHTML='<div class="cm-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';re.innerHTML='';}}

function showArticleList(){document.getElementById('articleList').classList.remove('hidden');document.getElementById('articleDetail').classList.add('hidden');document.getElementById('articleDetail').innerHTML='';}
function filterArticles(f){articleFilter=f;document.querySelectorAll('#articleFilters .cm-filter-pill').forEach(function(b,i){b.classList.toggle('active',i===(f==='all'?0:f==='admin'?1:2));});loadArticles(true);}
async function loadArticles(reset){if(reset)articleCursor=null;var el=document.getElementById('articleList');if(reset)el.innerHTML='<div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';try{var q='/api/community/articles?limit=10&filter='+articleFilter;if(articleCursor)q+='&cursor='+articleCursor;var d=await apiFetch(q);if(reset)el.innerHTML='';if(d.articles.length===0&&reset){el.innerHTML='<div class="cm-empty"><div class="cm-empty-icon">ğŸ“</div>ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';}d.articles.forEach(function(a){el.innerHTML+='<div class="cm-card" style="cursor:pointer;" onclick="showArticleDetail(\''+esc(a.id)+'\')">'+'<div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">'+'<span class="cm-tag">'+(a.type==='admin'?'ğŸ“Œ é‹å–¶':'âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼')+'</span>'+(a.tags||[]).map(function(t){return'<span class="cm-tag">'+esc(t)+'</span>';}).join('')+'</div>'+'<div style="font-size:16px;font-weight:700;margin-bottom:6px;line-height:1.4;">'+esc(a.title)+'</div>'+'<div style="font-size:13px;color:var(--gray-600);line-height:1.5;margin-bottom:8px;">'+esc(truncate(a.body,120))+'</div>'+'<div style="font-size:12px;color:var(--gray-400);display:flex;gap:12px;"><span>'+esc(a.nickname)+'</span><span>'+timeAgo(a.createdAt)+'</span><span>ğŸ’¬ '+(a.commentCount||0)+'</span></div></div>';});articleCursor=d.nextCursor;document.getElementById('articleLoadMore').classList.toggle('hidden',!d.hasMore);}catch(e){if(reset)el.innerHTML='<div class="cm-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';}}

async function showArticleDetail(id){var le=document.getElementById('articleList'),de=document.getElementById('articleDetail');le.classList.add('hidden');de.classList.remove('hidden');document.getElementById('articleLoadMore').classList.add('hidden');de.innerHTML='<div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';try{var[ar,cr]=await Promise.all([apiFetch('/api/community/articles/'+id),apiFetch('/api/community/articles/'+id+'/comments')]);var a=ar.article;var h='<button class="cm-back" onclick="showArticleList();loadArticles(true);">â† è¨˜äº‹ä¸€è¦§</button><div class="cm-card">';h+='<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;"><span class="cm-tag">'+(a.type==='admin'?'ğŸ“Œ é‹å–¶':'âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼')+'</span>';(a.tags||[]).forEach(function(t){h+='<span class="cm-tag">'+esc(t)+'</span>';});h+='</div><h2 style="font-size:20px;font-weight:800;line-height:1.4;margin-bottom:10px;">'+esc(a.title)+'</h2>';h+='<div class="cm-author-row">'+avatarHTML(a.nickname,a.author,28)+'<span class="cm-author-name">'+esc(a.nickname)+'</span><span style="font-size:12px;color:var(--gray-400);">'+timeAgo(a.createdAt)+'</span></div>';h+='<div class="cm-article-body">'+esc(a.body)+'</div>';if(currentUser&&(currentUser.email===a.author||currentUser.isAdmin)){h+='<div style="margin-top:16px;text-align:right;"><button class="cm-btn cm-btn-outline cm-btn-sm" style="color:var(--red);border-color:var(--red);" onclick="deleteArticle(\''+esc(a.id)+'\')">ğŸ—‘ å‰Šé™¤</button></div>';}h+='</div><div class="cm-card" style="margin-top:12px;"><div class="cm-comments-title">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ ('+(cr.comments||[]).length+')</div>';h+=renderComments(cr.comments||[],a.id);if(currentUser){h+='<div class="cm-reply-form"><input class="cm-input" id="articleCommentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã..." maxlength="300"><button class="cm-btn cm-btn-primary cm-btn-sm" onclick="postComment(\''+esc(a.id)+'\',\'articleCommentInput\')">é€ä¿¡</button></div>';}else{h+='<div class="cm-login-prompt"><a href="./index.html">Dayceã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã—ã‚ˆã†</div>';}h+='</div>';de.innerHTML=h;}catch(e){de.innerHTML='<button class="cm-back" onclick="showArticleList();loadArticles(true);">â† æˆ»ã‚‹</button><div class="cm-empty">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>';}}
async function deleteArticle(id){if(!confirm('ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;try{await apiFetch('/api/community/articles/delete',{method:'POST',body:{articleId:id}});showToast('è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');showArticleList();loadArticles(true);}catch(e){showToast('ã‚¨ãƒ©ãƒ¼: '+e.message);}}

function showForumCategories(){document.getElementById('forumCategories').classList.remove('hidden');document.getElementById('forumThreads').classList.add('hidden');document.getElementById('forumThread').classList.add('hidden');renderCategories();}
function renderCategories(){['goal','purpose'].forEach(function(g){var el=document.getElementById(g==='goal'?'goalCats':'purposeCats');el.innerHTML=CATEGORIES[g].map(function(c){return'<div class="cm-cat-card" onclick="openCategory(\''+c.id+'\')">'+'<span class="cm-cat-emoji">'+c.emoji+'</span>'+'<span class="cm-cat-label">'+esc(c.label)+'</span></div>';}).join('');});}
function openCategory(catId){currentCategory=catId;threadCursor=null;document.getElementById('forumCategories').classList.add('hidden');document.getElementById('forumThreads').classList.remove('hidden');document.getElementById('forumThread').classList.add('hidden');var ci=catInfo(catId);document.getElementById('threadListTitle').textContent=ci.emoji+' '+ci.label;document.getElementById('newThreadBtn').classList.toggle('hidden',!currentUser);loadThreads(true);}
async function loadThreads(reset){if(reset)threadCursor=null;var el=document.getElementById('threadList');if(reset)el.innerHTML='<div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';try{var q='/api/community/posts?limit=20&category='+currentCategory;if(threadCursor)q+='&cursor='+threadCursor;var d=await apiFetch(q);if(reset)el.innerHTML='';if(d.posts.length===0&&reset){el.innerHTML='<div class="cm-empty"><div class="cm-empty-icon">ğŸ’¬</div>ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“<br>æœ€åˆã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã‚ˆã†ï¼</div>';}d.posts.forEach(function(p){var t=p.title||truncate(p.body,50);el.innerHTML+='<div class="cm-thread-item" onclick="openThread(\''+esc(p.id)+'\')">'+'<div class="cm-thread-title">'+esc(t)+'</div>'+'<div class="cm-thread-meta"><span>'+esc(p.nickname)+'</span><span>ğŸ’¬ '+(p.commentCount||0)+'</span><span>'+timeAgo(p.lastActivity||p.createdAt)+'</span></div></div>';});threadCursor=d.nextCursor;document.getElementById('threadLoadMore').classList.toggle('hidden',!d.hasMore);}catch(e){if(reset)el.innerHTML='<div class="cm-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';}}

async function openThread(tid){currentThreadId=tid;document.getElementById('forumThreads').classList.add('hidden');document.getElementById('forumThread').classList.remove('hidden');var de=document.getElementById('threadDetail');de.innerHTML='<div class="cm-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';try{var[pr,cr]=await Promise.all([apiFetch('/api/community/posts?limit=50'+(currentCategory?'&category='+currentCategory:'')),apiFetch('/api/community/posts/'+tid+'/comments')]);var th=null;for(var i=0;i<pr.posts.length;i++){if(pr.posts[i].id===tid){th=pr.posts[i];break;}}if(!th){de.innerHTML='<div class="cm-empty">ã‚¹ãƒ¬ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';return;}var ci=catInfo(th.category);var t=th.title||truncate(th.body,50);var h='<div class="cm-thread-op"><span class="cm-tag">'+ci.emoji+' '+ci.label+'</span><div class="cm-thread-op-title">'+esc(t)+'</div><div class="cm-author-row">'+avatarHTML(th.nickname,th.author,28)+'<span class="cm-author-name">'+esc(th.nickname)+'</span><span style="font-size:12px;color:var(--gray-400);">'+timeAgo(th.createdAt)+'</span></div><div class="cm-thread-op-body">'+esc(th.body)+'</div>';if(currentUser&&(currentUser.email===th.author||currentUser.isAdmin)){h+='<div style="margin-top:12px;text-align:right;"><button class="cm-btn cm-btn-outline cm-btn-sm" style="color:var(--red);border-color:var(--red);" onclick="deleteThread(\''+esc(th.id)+'\')">ğŸ—‘ å‰Šé™¤</button></div>';}h+='</div><div class="cm-card"><div class="cm-comments-title">ğŸ’¬ è¿”ä¿¡ ('+(cr.comments||[]).length+')</div>';h+=renderComments(cr.comments||[],tid);if(currentUser){h+='<div class="cm-reply-form"><input class="cm-input" id="threadCommentInput" placeholder="è¿”ä¿¡ã‚’æ›¸ã..." maxlength="300"><button class="cm-btn cm-btn-primary cm-btn-sm" onclick="postComment(\''+esc(tid)+'\',\'threadCommentInput\')">é€ä¿¡</button></div>';}else{h+='<div class="cm-login-prompt"><a href="./index.html">Dayceã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦è¿”ä¿¡ã—ã‚ˆã†</div>';}h+='</div>';de.innerHTML=h;}catch(e){de.innerHTML='<div class="cm-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';}}
function openThreadDirect(tid,cat){currentCategory=cat||'chat';currentThreadId=tid;document.getElementById('forumCategories').classList.add('hidden');document.getElementById('forumThreads').classList.add('hidden');document.getElementById('forumThread').classList.remove('hidden');document.getElementById('threadBackBtn').onclick=function(){openCategory(currentCategory);};openThread(tid);}
function backToThreads(){document.getElementById('forumThread').classList.add('hidden');document.getElementById('forumThreads').classList.remove('hidden');}
async function deleteThread(id){if(!confirm('ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;try{await apiFetch('/api/community/posts/delete',{method:'POST',body:{postId:id}});showToast('ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');if(currentCategory)openCategory(currentCategory);else showForumCategories();}catch(e){showToast('ã‚¨ãƒ©ãƒ¼: '+e.message);}}

function renderComments(comments,targetId){if(!comments||comments.length===0)return'<div style="padding:8px 0;color:var(--gray-400);font-size:13px;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';return comments.map(function(c){var cd=currentUser&&(currentUser.email===c.author||currentUser.isAdmin);return'<div class="cm-comment"><div class="cm-comment-header">'+avatarHTML(c.nickname,c.author,22)+'<span class="cm-comment-nick">'+esc(c.nickname)+'</span><span class="cm-comment-time">'+timeAgo(c.createdAt)+'</span>'+(cd?'<span class="cm-comment-del" onclick="deleteComment(\''+esc(targetId)+'\',\''+esc(c.id)+'\')">å‰Šé™¤</span>':'')+'</div><div class="cm-comment-body">'+esc(c.body)+'</div></div>';}).join('');}
async function postComment(tid,iid){if(!requireLogin())return;var inp=document.getElementById(iid);var t=inp?inp.value.trim():'';if(!t)return;try{var ep=tid.startsWith('a_')?'/api/community/articles/'+tid+'/comments':'/api/community/posts/'+tid+'/comments';await apiFetch(ep,{method:'POST',body:{body:t}});inp.value='';showToast('ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ');if(tid.startsWith('a_'))showArticleDetail(tid);else openThread(tid);}catch(e){showToast('ã‚¨ãƒ©ãƒ¼: '+e.message);}}
async function deleteComment(tid,cid){if(!confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;try{await apiFetch('/api/community/comments/delete',{method:'POST',body:{targetId:tid,commentId:cid}});showToast('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');if(tid.startsWith('a_'))showArticleDetail(tid);else openThread(tid);}catch(e){showToast('ã‚¨ãƒ©ãƒ¼: '+e.message);}}

function showNewArticleModal(){if(!requireLogin())return;var o=document.createElement('div');o.className='cm-modal-overlay';o.id='articleModal';o.onclick=function(e){if(e.target===o)o.remove();};o.innerHTML='<div class="cm-modal"><button class="cm-modal-close" onclick="document.getElementById(\'articleModal\').remove()">&times;</button><div class="cm-modal-title">âœï¸ è¨˜äº‹ã‚’æ›¸ã</div><div class="cm-form-group"><label class="cm-form-label">ã‚¿ã‚¤ãƒˆãƒ«</label><input class="cm-input" id="articleTitleInput" placeholder="è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«" maxlength="100"></div><div class="cm-form-group"><label class="cm-form-label">æœ¬æ–‡</label><textarea class="cm-textarea" id="articleBodyInput" placeholder="å†…å®¹ã‚’æ›¸ã„ã¦ãã ã•ã„..." maxlength="5000" rows="10"></textarea><div class="cm-char-count"><span id="articleCharCount">0</span> / 5000</div></div><div class="cm-form-group"><label class="cm-form-label">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€æœ€å¤§5å€‹ï¼‰</label><input class="cm-input" id="articleTagsInput" placeholder="ä¾‹: ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ, ç¿’æ…£åŒ–, ã‚³ãƒ„"></div><button class="cm-btn cm-btn-primary" style="width:100%;" onclick="submitArticle()">æŠ•ç¨¿ã™ã‚‹</button></div>';document.body.appendChild(o);document.getElementById('articleBodyInput').addEventListener('input',function(){document.getElementById('articleCharCount').textContent=this.value.length;});}
async function submitArticle(){var ti=document.getElementById('articleTitleInput').value.trim(),bo=document.getElementById('articleBodyInput').value.trim(),ts=document.getElementById('articleTagsInput').value.trim();var tags=ts?ts.split(',').map(function(t){return t.trim();}).filter(Boolean).slice(0,5):[];if(!ti){showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}if(!bo){showToast('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}try{await apiFetch('/api/community/articles',{method:'POST',body:{title:ti,body:bo,tags:tags}});document.getElementById('articleModal').remove();showToast('è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼');loadArticles(true);}catch(e){showToast('ã‚¨ãƒ©ãƒ¼: '+e.message);}}

function showNewThreadModal(){if(!requireLogin())return;var ci=catInfo(currentCategory);var o=document.createElement('div');o.className='cm-modal-overlay';o.id='threadModal';o.onclick=function(e){if(e.target===o)o.remove();};var opts=ALL_CATS.map(function(c){return'<option value="'+c.id+'"'+(c.id===currentCategory?' selected':'')+'>'+c.emoji+' '+c.label+'</option>';}).join('');o.innerHTML='<div class="cm-modal"><button class="cm-modal-close" onclick="document.getElementById(\'threadModal\').remove()">&times;</button><div class="cm-modal-title">ğŸ’¬ æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰</div><div class="cm-form-group"><label class="cm-form-label">ã‚«ãƒ†ã‚´ãƒª</label><select class="cm-input" id="threadCatInput">'+opts+'</select></div><div class="cm-form-group"><label class="cm-form-label">ã‚¿ã‚¤ãƒˆãƒ«</label><input class="cm-input" id="threadTitleInput" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¿ã‚¤ãƒˆãƒ«" maxlength="100"></div><div class="cm-form-group"><label class="cm-form-label">æœ¬æ–‡</label><textarea class="cm-textarea" id="threadBodyInput" placeholder="å†…å®¹ã‚’æ›¸ã„ã¦ãã ã•ã„..." maxlength="2000" rows="6"></textarea><div class="cm-char-count"><span id="threadCharCount">0</span> / 2000</div></div><button class="cm-btn cm-btn-primary" style="width:100%;" onclick="submitThread()">æŠ•ç¨¿ã™ã‚‹</button></div>';document.body.appendChild(o);document.getElementById('threadBodyInput').addEventListener('input',function(){document.getElementById('threadCharCount').textContent=this.value.length;});}
async function submitThread(){var cat=document.getElementById('threadCatInput').value,ti=document.getElementById('threadTitleInput').value.trim(),bo=document.getElementById('threadBodyInput').value.trim();if(!ti){showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}if(!bo){showToast('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}try{await apiFetch('/api/community/posts',{method:'POST',body:{title:ti,body:bo,category:cat}});document.getElementById('threadModal').remove();showToast('ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼');currentCategory=cat;openCategory(cat);}catch(e){showToast('ã‚¨ãƒ©ãƒ¼: '+e.message);}}

function showNicknameModal(){var o=document.createElement('div');o.className='cm-modal-overlay';o.id='nicknameModal';o.onclick=function(e){if(e.target===o)o.remove();};o.innerHTML='<div class="cm-modal"><button class="cm-modal-close" onclick="document.getElementById(\'nicknameModal\').remove()">&times;</button><div class="cm-modal-title">ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š</div><p style="font-size:14px;color:var(--gray-600);margin-bottom:14px;">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§è¡¨ç¤ºã•ã‚Œã‚‹åå‰ã‚’è¨­å®šã—ã¦ãã ã•ã„</p><div class="cm-form-group"><input class="cm-input" id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆ1ã€œ20æ–‡å­—ï¼‰" maxlength="20"></div><button class="cm-btn cm-btn-primary" style="width:100%;" onclick="submitNickname()">è¨­å®šã™ã‚‹</button></div>';document.body.appendChild(o);}
async function submitNickname(){var n=document.getElementById('nicknameInput').value.trim();if(!n){showToast('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}try{await apiFetch('/api/community/me',{method:'POST',body:{nickname:n}});currentUser.nickname=n;updateAuthUI();document.getElementById('nicknameModal').remove();showToast('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¾ã—ãŸ');}catch(e){showToast('ã‚¨ãƒ©ãƒ¼: '+e.message);}}

document.addEventListener('DOMContentLoaded',async function(){await initUser();var h=location.hash.slice(1);if(['home','articles','forum'].includes(h))switchTab(h);else switchTab('home');});
</script>
</body>
</html>
